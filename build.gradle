group 'tronlink-UI-test'
version '1.0-SNAPSHOT'
apply plugin: 'java'
apply plugin: 'maven'
apply plugin: 'eclipse'

sourceCompatibility = 1.8

repositories {

    maven { url "https://cloud.experitest.com/repo" }
    maven { url "http://repo.maven.apache.org/maven2" }
    mavenCentral()
}

dependencies {
    compile group: 'com.alibaba', name: 'fastjson', version: '1.2.44'
    compile group: 'org.testng', name: 'testng', version: '6.9.9'
    compile group: 'io.appium', name: 'java-client', version: '7.2.0'
    compile group: 'com.google.zxing', name: 'core', version: '3.1.0'

}

test {
    useTestNG(){
        suites 'testng.xml'
    }
}

task tronlinkTask(type: Test,dependsOn: 'autoCreateTestngXml') {
    useTestNG {
        suites(file('src/test/resources/tronlink-testng.xml'))
        parallel 'tests'
        threadCount 1
    }
}

task tronlink(type: Exec) {
    dependsOn 'tronlinkTask'
    //commandLine 'sh', '-c', 'collectExceptionLog.sh'
    workingDir "$projectDir/"
    executable 'sh'
    args "-c","./collectExceptionLog.sh"
    doLast {
        println("before do last testng")
/*        if (tasks.listenTronlinkException.process != null) {
            tasks.listenTronlinkException.process.destroy()
        }*/
        println("after do last testng")

    }
}

task autoCreateTestngXml(type: Test,dependsOn: 'listenTronlinkException') {
    useTestNG {
        suites(file('src/test/resources/autoCreateTestngXml.xml'))
        parallel 'tests'
        threadCount 1
    }
}

task listenTronlinkException() {
    doFirst {
        workingDir "$projectDir/"
        ext.process = new ProcessBuilder()
                .command('sh', '-c', 'listenTronlinkException.sh')
                .start()
    }

}
